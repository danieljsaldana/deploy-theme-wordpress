name: DigitalOcean

on:    
  workflow_call:

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:  # Definir las variables de entorno
      TF_DO_PUBLIC_KEY: ${{ secrets.TF_DIGITALOCEAN_PUB }}.pub 

    steps:
    - name: Checkout c√≥digo fuente
      uses: actions/checkout@v2

    - name: Configurar Terraform
      run: |
        terraform -chdir=./terraform init -var "do_token=$DIGITALOCEAN_TOKEN" -var "do_public_key=$TF_DO_PUBLIC_KEY"
        terraform -chdir=./terraform validate

    - name: Aplicar infraestructura
      run: |
        terraform -chdir=./terraform apply -auto-approve -var "do_token=$DIGITALOCEAN_TOKEN" -var "do_public_key=$TF_DO_PUBLIC_KEY"

    - name: Esperar 30 minutos
      run: sleep 1800

    - name: Destruir infraestructura
      run: |
        terraform -chdir=./terraform destroy -auto-approve -var "do_token=$DIGITALOCEAN_TOKEN" -var "do_public_key=$TF_DO_PUBLIC_KEY"
    

